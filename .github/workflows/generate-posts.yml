name: Generate Blog Posts for New Projects

on:
  # Trigger after Deploy workflow completes
  workflow_run:
    workflows: ["Deploy to Cloudflare"]
    types:
      - completed

  # Manual trigger
  workflow_dispatch:
    inputs:
      force:
        description: 'Force check for missing posts (even without file changes)'
        required: false
        default: 'false'

jobs:
  detect-and-trigger:
    runs-on: ubuntu-latest
    # Only run if deploy succeeded, or if manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if projects.md changed
        id: check-projects
        if: github.event_name != 'workflow_dispatch'
        run: |
          # Get the head SHA from the triggering workflow
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          
          # Fetch the specific commit to check what files changed
          git fetch origin ${HEAD_SHA} --depth=2
          
          # Check if projects.md was in the changed files
          CHANGED_FILES=$(git diff --name-only ${HEAD_SHA}~1 ${HEAD_SHA} 2>/dev/null || echo "")
          
          if echo "$CHANGED_FILES" | grep -q "packages/web/content/projects.md"; then
            echo "projects_changed=true" >> $GITHUB_OUTPUT
            echo "projects.md was changed"
          else
            echo "projects_changed=false" >> $GITHUB_OUTPUT
            echo "projects.md was not changed, skipping post generation"
          fi

      - name: Setup Node.js
        if: |
          github.event_name == 'workflow_dispatch' ||
          steps.check-projects.outputs.projects_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install js-yaml
        if: |
          github.event_name == 'workflow_dispatch' ||
          steps.check-projects.outputs.projects_changed == 'true'
        run: npm install js-yaml

      - name: Detect missing posts
        if: |
          github.event_name == 'workflow_dispatch' ||
          steps.check-projects.outputs.projects_changed == 'true'
        id: detect
        run: |
          # Parse projects from projects.md frontmatter and find missing posts
          node << 'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');
          const path = require('path');

          // Read projects.md
          const projectsPath = 'packages/web/content/projects.md';
          const projectsContent = fs.readFileSync(projectsPath, 'utf8');

          // Extract YAML frontmatter
          const frontmatterMatch = projectsContent.match(/^---\n([\s\S]*?)\n---/);
          if (!frontmatterMatch) {
            console.log('No frontmatter found in projects.md');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'missing=[]\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'missing_count=0\n');
            process.exit(0);
          }

          const data = yaml.load(frontmatterMatch[1]);
          const projects = data.projects || [];

          // Filter to only featured projects (those that should have posts)
          const featuredProjects = projects.filter(p => p.featured);
          console.log(`Found ${featuredProjects.length} featured projects`);

          // Get existing post slugs
          const writingDir = 'packages/web/content/writing';
          let existingPosts = [];
          if (fs.existsSync(writingDir)) {
            existingPosts = fs.readdirSync(writingDir)
              .filter(f => f.endsWith('.mdx'))
              .map(f => f.replace('.mdx', ''));
          }
          console.log(`Found ${existingPosts.length} existing posts:`, existingPosts);

          // Find projects without posts
          const missing = featuredProjects.filter(p => {
            const expectedSlug = `project-${p.slug}`;
            return !existingPosts.includes(expectedSlug);
          });

          console.log(`Missing posts for ${missing.length} projects:`, missing.map(p => p.slug));

          // Write outputs
          const missingJson = JSON.stringify(missing);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `missing=${missingJson}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `missing_count=${missing.length}\n`);
          EOF

      - name: Display detection results
        if: |
          github.event_name == 'workflow_dispatch' ||
          steps.check-projects.outputs.projects_changed == 'true'
        run: |
          echo "Missing count: ${{ steps.detect.outputs.missing_count }}"
          echo "Missing projects: ${{ steps.detect.outputs.missing }}"

      - name: Trigger Cloudflare Workflow
        if: |
          (github.event_name == 'workflow_dispatch' || steps.check-projects.outputs.projects_changed == 'true') &&
          steps.detect.outputs.missing_count != '0'
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
        run: |
          echo "Triggering workflow for ${{ steps.detect.outputs.missing_count }} projects..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${SITE_URL}/api/trigger-workflow" \
            -H "Authorization: Bearer ${ADMIN_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"projectsToProcess": ${{ steps.detect.outputs.missing }}}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to trigger workflow. HTTP $HTTP_CODE"
            exit 1
          fi
          
          echo "Workflow triggered successfully!"
          echo "::notice::Post generation workflow started for ${{ steps.detect.outputs.missing_count }} projects"

      - name: No missing posts
        if: |
          (github.event_name == 'workflow_dispatch' || steps.check-projects.outputs.projects_changed == 'true') &&
          steps.detect.outputs.missing_count == '0'
        run: |
          echo "All featured projects already have blog posts."
          echo "::notice::No new posts to generate"

      - name: Skip - No projects.md changes
        if: |
          github.event_name != 'workflow_dispatch' &&
          steps.check-projects.outputs.projects_changed != 'true'
        run: |
          echo "projects.md was not changed in this deployment, skipping post generation."
          echo "::notice::Skipped - no projects.md changes"
